# You need to set up Workload Identity Federation in your Google Cloud project in order to use this GitHub Actions definition: https://medium.com/p/3932dce678b8.
# And the secrets.GSA_ID needs to have the roles/artifactregistry.repoAdmin role in order push and delete container images.
name: open-pr
permissions:
  contents: read
  id-token: write
  pull-requests: write
on:
  pull_request:
env:
  ENVIRONMENT_ID: pr-${{ github.event.number }}
  IMAGE_NAME: ${{ secrets.REGISTRY_LOCATION }}-docker.pkg.dev/${{ secrets.PROJECT_ID }}/${{ secrets.REGISTRY_NAME }}/my-sample-workload
  SCORE_COMPOSE_VERSION: 'latest'
  SCORE_K8S_VERSION: 'latest'
  WORKLOAD_NAME: my-sample-workload
  CONTAINER_NAME: my-sample-container
  HUMCTL_VERSION: '*'
jobs:
  test:
    runs-on: ubuntu-24.04
    steps:
      - name: checkout code
        uses: actions/checkout@v4
      - name: build container
        run: |
          docker build \
              --tag ghcr.io/${{ github.repository_owner }}/${{ env.WORKLOAD_NAME }}:test \
              --platform linux/amd64,linux/arm64 \
              app/
      - name: login to ghcr
        run: |
          echo ${{ secrets.GITHUB_TOKEN }} | docker login \
              ghcr.io \
              -u $ \
              --password-stdin
      - name: push container in ghcr
        run: |
          docker push \
              ghcr.io/${{ github.repository_owner }}/${{ env.WORKLOAD_NAME }}:latest
      
      - run: |
          docker build -t my-sample-workload:test --platform linux/amd64,linux/arm64 ./app
      - run: |
          docker images
          docker inspect my-sample-workload:test
